name: 'ðŸŽ¨ Crafters Guild: UI Accessibility Check'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    paths:
      - 'ForgeTM/apps/frontend/**'
      - 'GoblinOS/packages/goblins/overmind/dashboard/**'
      - '**/*.tsx'
      - '**/*.jsx'
      - '**/*.css'
      - '**/*.scss'
      - 'tailwind.config.js'
      - 'postcss.config.js'

jobs:
  ui-a11y-check:
    name: 'UI Accessibility Check'
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'crafters/ui-a11y-check') || contains(github.event.pull_request.labels.*.name, 'guild:crafters')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run accessibility audit
        run: |
          # Install accessibility tools
          pnpm add -D axe-core @axe-core/playwright

          # Build frontend for testing
          cd ForgeTM/apps/frontend
          pnpm build

          # Run accessibility tests
          pnpm test:e2e -- --headed=false --grep="accessibility"

      - name: Check color contrast
        run: |
          # Install contrast checker
          pnpm add -D @adobe/leonardo-contrast-colors

          # Run contrast analysis on CSS variables
          node -e "
            const { Color } = require('@adobe/leonardo-contrast-colors');
            // Placeholder for contrast checking logic
            console.log('Color contrast check completed');
          "

      - name: Validate UI components
        run: |
          cd GoblinOS/packages/goblins/overmind/dashboard
          pnpm lint
          pnpm type-check

          # Check for proper ARIA labels and semantic HTML
          npx eslint . --ext ts,tsx --rule 'jsx-a11y/aria-role: error' --rule 'jsx-a11y/alt-text: error'

      - name: Performance budget check
        run: |
          # Check bundle size against CLS budget (< 0.1)
          cd ForgeTM/apps/frontend
          pnpm build
          npx bundlesize --max-size 500k dist/assets/*.js

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš¨ **Crafters Guild UI Check Failed**\n\nThe UI accessibility and quality checks have failed. Please review:\n- Accessibility violations\n- Color contrast ratios\n- Bundle size budget\n- Component semantic markup\n\n@Vanta Lumin (Glyph Scribe) has been notified for review.'
            })

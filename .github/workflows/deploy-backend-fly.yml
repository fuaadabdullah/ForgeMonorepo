name: Deploy Backend to Fly.io

on:
  push:
    branches: [ main, fix/docs-lint-2 ]
    paths:
      - 'apps/goblin-assistant/backend/**'
      - 'apps/goblin-assistant/Dockerfile.prod'
      - 'apps/goblin-assistant/fly.toml'
      - '.github/workflows/deploy-backend-fly.yml'
  workflow_dispatch:

concurrency:
  group: fly-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: https://goblin-backend.fly.dev
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --config fly.toml
        working-directory: apps/goblin-assistant
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Health check
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          status=$(curl -s -o /dev/null -w "%{http_code}" https://goblin-backend.fly.dev/health)
          if [ "$status" = "200" ]; then
            echo "Backend healthy (HTTP $status)"
          else
            echo "Health check returned HTTP $status â€” may still be starting"
          fi

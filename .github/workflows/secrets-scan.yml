name: "Secrets scanning (gitleaks + trufflehog + detect-secrets)"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC
  workflow_dispatch:

jobs:
  secrets-scan:
    name: Run secrets scanners and upload SARIF
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # needed for uploading SARIF

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install scanner dependencies
        run: |
          python -m pip install --upgrade pip
          pip install detect-secrets trufflehog || true
          # gitleaks will be used from the official action if available; otherwise install CLI
          if ! command -v gitleaks >/dev/null 2>&1; then
            curl -sSfL https://raw.githubusercontent.com/zricethezav/gitleaks/main/install.sh | bash -s -- -b $HOME/.local/bin v8.7.0 || true
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Run secrets scan (wrapper)
        run: |
          bash tools/secrets/secrets_scan.sh --ci --output-dir artifacts/secrets

      - name: Run secrets smoke test (validate SARIF)
        run: |
          bash tools/secrets/test_harness/run_smoke_test.sh

      - name: Detect SARIF artifacts
        id: detect_sarif
        run: |
          echo "gitleaks=$(if [ -f artifacts/sarif/gitleaks.sarif ]; then echo true; else echo false; fi)" >> $GITHUB_OUTPUT
          echo "trufflehog=$(if [ -f artifacts/sarif/trufflehog.sarif ]; then echo true; else echo false; fi)" >> $GITHUB_OUTPUT
          echo "detectsecrets=$(if [ -f artifacts/sarif/detect-secrets.sarif ]; then echo true; else echo false; fi)" >> $GITHUB_OUTPUT

      - name: Upload raw scanner artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secrets-raw
          path: artifacts/secrets/**

      - name: Upload gitleaks SARIF
        if: steps.detect_sarif.outputs.gitleaks == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: artifacts/sarif/gitleaks.sarif

      - name: Upload trufflehog SARIF
        if: steps.detect_sarif.outputs.trufflehog == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: artifacts/sarif/trufflehog.sarif

      - name: Upload detect-secrets SARIF
        if: steps.detect_sarif.outputs.detectsecrets == 'true'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: artifacts/sarif/detect-secrets.sarif

name: Environment & Secrets Validation

on:
  push:
    paths:
      - '**/.env.example'
      - '**/secrets/**'
      - 'GoblinOS/packages/goblins/forge-smithy/smithy/automation/env_validator.py'
      - '.github/workflows/env-validation.yml'
  pull_request:
    paths:
      - '**/.env.example'
      - '**/secrets/**'
      - 'GoblinOS/packages/goblins/forge-smithy/smithy/automation/env_validator.py'
      - '.github/workflows/env-validation.yml'
  schedule:
    # Run environment validation daily to catch issues
    - cron: '0 3 * * *'  # Daily 3 AM UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  validate-environment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install uv (Python package manager)
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install Smithy and dependencies
        run: |
          cd GoblinOS/packages/goblins/forge-smithy
          uv sync --dev

      - name: Validate environment configuration
        id: env-validation
        run: |
          echo "üîç Running comprehensive environment validation..."

          # Create validation report
          REPORT_FILE="env-validation-report.md"
          echo "# Environment & Secrets Validation Report" > $REPORT_FILE
          echo "Date: $(date)" >> $REPORT_FILE
          echo "Trigger: ${{ github.event_name }}" >> $REPORT_FILE
          echo "Run: $GITHUB_RUN_ID" >> $REPORT_FILE
          echo "" >> $REPORT_FILE

          # Run Smithy environment validation
          cd GoblinOS/packages/goblins/forge-smithy
          if uv run python -m smithy.cli env_report >> $REPORT_FILE 2>&1; then
            echo "ENV_VALIDATION_STATUS=passed" >> $GITHUB_ENV
            echo "‚úÖ Environment validation passed" >> $REPORT_FILE
          else
            echo "ENV_VALIDATION_STATUS=failed" >> $GITHUB_ENV
            echo "‚ùå Environment validation failed" >> $REPORT_FILE
          fi

          echo "" >> $REPORT_FILE
          echo "--- Full Report ---" >> $REPORT_FILE
          echo "\`\`\`" >> $REPORT_FILE
          uv run python -m smithy.cli env_report >> $REPORT_FILE 2>&1 || true
          echo "\`\`\`" >> $REPORT_FILE

          # Upload report as artifact
          mkdir -p reports
          cp $REPORT_FILE reports/

          echo "\n--- Environment Validation Report ---"
          cat $REPORT_FILE

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: environment-validation-report
          path: reports/env-validation-report.md

      - name: Check for critical environment issues
        if: env.ENV_VALIDATION_STATUS == 'failed'
        run: |
          echo "üö® Critical environment validation failures detected!"
          echo "Check the validation report for details."
          exit 1

      - name: Sync environment examples (on schedule only)
        if: github.event_name == 'schedule'
        run: |
          echo "üîÑ Syncing .env.example files with available secrets..."
          cd GoblinOS/packages/goblins/forge-smithy
          uv run python -m smithy.cli env_sync

          # Check if any files were modified
          if git diff --quiet; then
            echo "‚úÖ No .env.example files needed updates"
          else
            echo "üìù .env.example files were updated"
            git diff --name-only
            # Create a PR for the updates
            echo "SYNC_NEEDED=true" >> $GITHUB_ENV
          fi

      - name: Create sync PR (if needed)
        if: env.SYNC_NEEDED == 'true' && github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync .env.example files with available secrets"
          title: "üîÑ Sync Environment Examples"
          body: |
            ## Environment Sync

            This PR updates `.env.example` files to include any newly available secrets from the secrets manager.

            ### Changes
            - Updated `.env.example` files with available secrets
            - Maintains placeholder values for security

            ### Validation
            - All environment validation checks pass
            - No breaking changes to existing configurations

            ---
            ü§ñ Auto-generated by environment validation workflow
          branch: env-sync-${{ github.run_id }}
          delete-branch: true

      - name: Send Slack notification on failures
        if: failure() && (github.event_name == 'schedule' || github.event_name == 'push')
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "üö® Environment Validation Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Environment & Secrets Validation Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:* ‚ùå Failed"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Trigger:* ${{ github.event_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": "Check the validation report artifact for detailed error information."
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Send Slack notification on nightly success
        if: success() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "‚úÖ Nightly Environment Validation Complete",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Environment & Secrets Validation Complete"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:* üü¢ Passed"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
